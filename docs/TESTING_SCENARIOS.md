# Сценарии тестирования Firebase Push Notifications

## Сценарий 1: Новый гостевой пользователь

1. Открыть сайт в режиме инкогнито
2. Через 2 секунды должен появиться диалог запроса разрешений
3. Нажать "Разрешить"
4. Токен должен сохраниться в localStorage
5. В консоли должно быть: "Token saved successfully for guest user"

## Сценарий 2: Авторизованный пользователь (первый раз)

1. Авторизоваться на сайте
2. Через 2 секунды должен появиться диалог запроса разрешений
3. Нажать "Разрешить"
4. Токен должен сохраниться в localStorage И отправиться на сервер
5. В консоли должно быть: "Token saved successfully for logged in user"

## Сценарий 3: Авторизованный пользователь сбросил разрешения

1. Авторизоваться на сайте (уже имея токен в localStorage)
2. В браузере сбросить разрешения для уведомлений (Settings → Notifications)
3. Обновить страницу
4. Через 2 секунды должен появиться диалог запроса разрешений
5. Нажать "Разрешить"
6. **Сохраненный токен должен сразу отправиться на сервер**
7. В консоли должно быть: "Found stored token for logged in user with granted permission, syncing with server"

## Сценарий 4: Гость становится пользователем

1. Как гость получить токен (Сценарий 1)
2. Авторизоваться на сайте
3. Токен должен автоматически синхронизироваться с сервером
4. В консоли должно быть: "Found stored token for logged in user, syncing with server"

## Сценарий 5: Мониторинг изменений разрешений

1. Авторизоваться и получить разрешения
2. В настройках браузера запретить уведомления для сайта
3. Токен должен удалиться из localStorage
4. В консоли должно быть: "Permission denied, clearing stored token if exists"
5. Снова разрешить уведомления в браузере
6. Если есть сохраненный токен, он должен отправиться на сервер

## Проверка в админке

1. Перейти в админку WordPress → Firebase Push
2. Проверить статистику:
   - Количество пользователей с токенами
   - Количество гостевых токенов
   - Общее количество устройств

## Тестирование отправки

1. В админке перейти на страницу с параметром `?test_guest_notifications=1`
2. Должна появиться тестовая панель
3. Нажать "Тест уведомления"
4. Все устройства (пользователи + гости) должны получить уведомление

## Консольные команды для отладки

```javascript
// Проверить сохраненный токен
localStorage.getItem('fcm_token')

// Проверить статус разрешений
Notification.permission

// Проверить, был ли уже запрос разрешений
localStorage.getItem('fcm_permission_asked')

// Очистить все данные Firebase
localStorage.removeItem('fcm_token')
localStorage.removeItem('fcm_permission_asked')
localStorage.clear() // осторожно - удалит все данные

// Принудительно запросить разрешения
window.firebasePushNotifications.requestPermission()
```

## Ожидаемое поведение

### Для всех пользователей

- ✅ Диалог показывается только один раз
- ✅ Токены сохраняются в localStorage
- ✅ Нет дублирования запросов на сервер

### Для авторизованных пользователей

- ✅ Токены синхронизируются с сервером
- ✅ При сбросе разрешений сохраненный токен используется повторно
- ✅ Мониторинг изменений разрешений работает

### Для гостей

- ✅ Токены сохраняются локально
- ✅ При авторизации токены переносятся на сервер
- ✅ Старые токены очищаются через 30 дней
