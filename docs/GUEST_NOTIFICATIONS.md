# Уведомления для гостевых пользователей

## Обзор изменений

Плагин Firebase Push Notifications был модифицирован для поддержки push-уведомлений для всех посетителей сайта, включая неавторизованных пользователей.

## Основные изменения

### 1. Клиентская часть (firebase-init.js)

- **Инициализация для всех пользователей**: Плагин теперь инициализируется для всех посетителей, а не только для авторизованных
- **Диалог запроса разрешений**: Автоматически показывается красивый диалог с запросом разрешения на уведомления через 2 секунды после загрузки страницы
- **Локальное хранение токенов**: FCM токены сохраняются в localStorage браузера
- **Синхронизация при авторизации**: При входе пользователя проверяется наличие токена в localStorage и синхронизируется с сервером

### 2. Серверная часть

#### Сохранение токенов

- **Гостевые токены**: Токены неавторизованных пользователей сохраняются в опции `firebase_guest_tokens`
- **Пользовательские токены**: Токены авторизованных пользователей сохраняются в user_meta как раньше
- **Автоматическая синхронизация**: При авторизации пользователя его гостевые токены автоматически переносятся в user_meta

#### Отправка уведомлений

- **Новый метод `sendNotificationToAll()`**: Отправляет уведомления всем пользователям (авторизованным и гостям)
- **Обновленная статистика**: В админке отображается количество гостевых устройств отдельно

#### Очистка данных

- **Автоматическая очистка**: Ежедневно удаляются гостевые токены старше 30 дней
- **Удаление неактивных токенов**: Токены, которые не могут получить уведомления, автоматически удаляются

## Структура данных

### Гостевые токены (firebase_guest_tokens)

```php
array(
    array(
        'token' => 'fcm_token_string',
        'created_at' => '2024-01-01 12:00:00',
        'ip_address' => '192.168.1.1',
        'user_agent' => 'Mozilla/5.0...'
    ),
    // ...
)
```

### Пользовательские токены (_fcm_device_tokens)

```php
array(
    'fcm_token_string_1',
    'fcm_token_string_2',
    // ...
)
```

## Логика работы с разрешениями

### Для авторизованных пользователей

1. **При первом посещении**: Показывается диалог запроса разрешений
2. **При сбросе разрешений**: Если пользователь сбросил разрешения, но у него есть сохраненный токен в localStorage, то при повторном разрешении токен сразу отправляется на сервер
3. **Мониторинг изменений**: Система отслеживает изменения разрешений в реальном времени
4. **Защита от спама**: Токен не отправляется повторно на сервер чаще чем раз в минуту

### Для гостевых пользователей

1. **Локальное хранение**: Токены сохраняются только в localStorage
2. **Автоматическая синхронизация**: При авторизации токены переносятся на сервер

## Использование

### Отправка уведомлений всем пользователям

```php
$firebase_manager = FirebaseManager::getInstance();
$result = $firebase_manager->sendNotificationToAll(
    'Заголовок уведомления',
    'Текст уведомления',
    array('action_url' => 'https://example.com'),
    'general'
);

// $result содержит:
// array(
//     'success' => 15,  // Успешно отправлено
//     'failed' => 2,    // Не удалось отправить
//     'total' => 17     // Всего попыток
// )
```

### Отправка уведомлений конкретному пользователю

```php
$firebase_manager = FirebaseManager::getInstance();
$success = $firebase_manager->sendNotificationToUser(
    $user_id,
    'Заголовок',
    'Текст',
    array('action_url' => 'https://example.com'),
    'message'
);
```

## Безопасность

- Гостевые токены привязываются к IP-адресу и User-Agent для базовой идентификации
- Токены автоматически удаляются через 30 дней
- Неактивные токены удаляются при неудачных попытках отправки

## Совместимость

Все изменения обратно совместимы. Существующие пользователи с сохраненными токенами продолжат получать уведомления как раньше.
