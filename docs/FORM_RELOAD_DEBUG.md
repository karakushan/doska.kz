# Отладка проблемы с перезагрузкой формы рекламы

## Проблема

Форма рекламирования объявления просто перезагружается после клика на кнопку отправки, вместо обработки данных.

## Внесенные исправления

### 1. Исправлен атрибут action формы

**Было:** `<form method="post" action="" class="advertising-form">`
**Стало:** `<form method="post" action="<?php echo esc_url($_SERVER['REQUEST_URI']); ?>" class="advertising-form">`

### 2. Улучшено условие подключения скриптов

Расширено условие в `functions.php` для подключения JavaScript файла:

```php
$is_advertise_page = is_page('advertise-listing') || 
                     (isset($_SERVER['REQUEST_URI']) && strpos($_SERVER['REQUEST_URI'], '/advertise-listing/') !== false) ||
                     (isset($_SERVER['REQUEST_URI']) && strpos($_SERVER['REQUEST_URI'], 'advertise_listing') !== false) ||
                     (isset($_GET['listing_id']) && isset($_GET['action']) && $_GET['action'] === 'advertise_listing');
```

### 3. Добавлена защита от двойной отправки

В JavaScript добавлена переменная `formSubmitted` для предотвращения повторной отправки формы.

### 4. Улучшено логирование PHP

Добавлено подробное логирование для отслеживания:

- Получения данных формы
- Проверки nonce
- Получения ID продуктов
- Процесса добавления в корзину

### 5. Добавлена отладочная информация

- В HTML добавлен блок с отладочной информацией
- В JavaScript добавлены console.log для отслеживания событий
- Добавлены обработчики для отслеживания кликов по кнопке

## Что нужно проверить

### 1. Консоль браузера

Откройте Developer Tools (F12) и проверьте:

- Загружается ли JavaScript файл
- Есть ли ошибки JavaScript
- Выводятся ли сообщения отладки при клике на кнопку

### 2. Логи WordPress

Проверьте логи WordPress (обычно в `/wp-content/debug.log`) на наличие:

- Сообщений об обработке формы
- Ошибок PHP
- Информации о продуктах WooCommerce

### 3. Настройки продуктов WooCommerce

Убедитесь, что созданы продукты для рекламирования:

- Продукт для 1 дня
- Продукт для 3 дней  
- Продукт для 7 дней

### 4. Проверьте URL страницы

Убедитесь, что вы находитесь на правильной странице с параметрами:
`/dashboard/?action=advertise_listing&listing_id=XXX`

## Возможные причины проблемы

1. **JavaScript конфликты** - другие плагины могут перехватывать отправку формы
2. **Неправильные ID продуктов** - продукты WooCommerce не созданы или имеют неправильные ID
3. **Проблемы с nonce** - проверка безопасности не проходит
4. **Ошибки PHP** - фатальные ошибки вызывают перезагрузку страницы
5. **Проблемы с сессией** - пользователь не авторизован или сессия истекла

## Следующие шаги

1. Откройте страницу рекламирования в браузере
2. Откройте Developer Tools (F12)
3. Попробуйте отправить форму
4. Проверьте консоль на наличие сообщений
5. Проверьте логи WordPress
6. Сообщите о результатах для дальнейшей диагностики
